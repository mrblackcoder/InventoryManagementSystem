<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Reports - Inventory Management System</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <div class="dashboard">
        <nav class="sidebar">
            <h2>üì¶ IMS Admin</h2>
            <ul>
                <li><a th:href="@{/dashboard}">Dashboard</a></li>
                <li><a th:href="@{/products}">Products</a></li>
                <li><a th:href="@{/categories}">Categories</a></li>
                <li><a th:href="@{/suppliers}">Suppliers</a></li>
                <li><a th:href="@{/admin/users}">User Management</a></li>
                <li><a th:href="@{/admin/reports}" class="active">Reports</a></li>
            </ul>
            <form th:action="@{/logout}" method="post" class="logout-form">
                <button type="submit" class="btn btn-logout">Logout</button>
            </form>
        </nav>

        <main class="content">
            <header class="dashboard-header">
                <h1>üìä Stock Transaction Reports</h1>
                <p>Admin Panel - View and Analyze Stock Movements</p>
            </header>

            <div class="filter-section">
                <h3>Filter Reports</h3>
                <div class="filter-row">
                    <div class="form-group">
                        <label>Movement Type</label>
                        <select id="filterType">
                            <option value="">All Types</option>
                            <option value="IN">Purchases (IN)</option>
                            <option value="OUT">Sales (OUT)</option>
                            <option value="RETURN">Returns</option>
                            <option value="ADJUSTMENT">Adjustments</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date Range</label>
                        <select id="dateRange" onchange="loadRecentMovements()">
                            <option value="7">Last 7 Days</option>
                            <option value="30">Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="loadRecentMovements()">üîç Filter</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card stat-in">
                    <h3>Total Purchases (IN)</h3>
                    <p class="stat-number" id="totalPurchases">0</p>
                </div>
                <div class="stat-card stat-out">
                    <h3>Total Sales (OUT)</h3>
                    <p class="stat-number" id="totalSales">0</p>
                </div>
                <div class="stat-card">
                    <h3>Total Returns</h3>
                    <p class="stat-number" id="totalReturns">0</p>
                </div>
                <div class="stat-card">
                    <h3>Total Movements</h3>
                    <p class="stat-number" id="totalMovements">0</p>
                </div>
            </div>

            <section class="data-section">
                <div class="section-header">
                    <h2>Recent Stock Movements</h2>
                    <button class="btn btn-primary" onclick="loadRecentMovements()">üîÑ Refresh</button>
                </div>

                <table id="movementsTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Product</th>
                            <th>Type</th>
                            <th>Quantity</th>
                            <th>Performed By</th>
                            <th>Reason</th>
                        </tr>
                    </thead>
                    <tbody id="movementsTableBody">
                        <tr>
                            <td colspan="6" style="text-align: center;">Loading movements...</td>
                        </tr>
                    </tbody>
                </table>
            </section>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadRecentMovements();
        });

        function loadRecentMovements() {
            fetch('/api/stock-movements/recent')
                .then(response => response.json())
                .then(movements => {
                    displayMovements(movements);
                    updateStats(movements);
                })
                .catch(error => {
                    console.error('Error loading movements:', error);
                    document.getElementById('movementsTableBody').innerHTML =
                        '<tr><td colspan="6" style="text-align: center; color: red;">Error loading movements</td></tr>';
                });
        }

        function displayMovements(movements) {
            const tbody = document.getElementById('movementsTableBody');

            if (movements.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No movements found</td></tr>';
                return;
            }

            tbody.innerHTML = movements.map(movement => `
                <tr>
                    <td>${new Date(movement.movementDate).toLocaleString()}</td>
                    <td>${movement.product.name} (${movement.product.sku})</td>
                    <td><span class="badge badge-${movement.type.toLowerCase()}">${movement.type}</span></td>
                    <td>${movement.quantity}</td>
                    <td>${movement.performedBy ? movement.performedBy.username : 'System'}</td>
                    <td>${movement.reason || '-'}</td>
                </tr>
            `).join('');
        }

        function updateStats(movements) {
            const purchases = movements.filter(m => m.type === 'IN');
            const sales = movements.filter(m => m.type === 'OUT');
            const returns = movements.filter(m => m.type === 'RETURN');

            document.getElementById('totalPurchases').textContent =
                purchases.reduce((sum, m) => sum + m.quantity, 0);
            document.getElementById('totalSales').textContent =
                sales.reduce((sum, m) => sum + m.quantity, 0);
            document.getElementById('totalReturns').textContent =
                returns.reduce((sum, m) => sum + m.quantity, 0);
            document.getElementById('totalMovements').textContent = movements.length;
        }
    </script>
</body>
</html>
